(function() {
    'use strict';
    const d = document;
    const loc = d.location.href;
    const table = d.querySelector('table.rowFlow');

    if (!table) return alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø© ÙÙŠ ØµÙØ­Ø© "ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ù‚Ø±Ø±Ø§Øª"');

    let courses = [];
    d.querySelectorAll('table.rowFlow tbody tr').forEach(r => {
        const a = r.querySelector('a[onmousedown*="setIndex"]');
        if (a) {
            const m = a.getAttribute('onmousedown').match(/\d+/);
            if (m) courses.push({ id: m[0], name: r.cells[1] ? r.cells[1].innerText : 'M' + m[0] });
        }
    });

    if (!courses.length) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù…ØªØ§Ø­Ø© Ù„Ù„ØªÙ‚ÙŠÙŠÙ…');

    const css = `
        @import url("https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=IBM+Plex+Sans+Arabic:wght@700&display=swap");
        :root {
            --primary: #5e9cff;
            --primary-dark: #4b7dcc;
            --bg: #0a0a0a;
            --card: rgba(20, 20, 22, 0.95);
            --border: rgba(255, 255, 255, 0.1);
            --text: #e0e0e0;
            --green: #00c853;
            --font-title: "IBM Plex Sans Arabic", sans-serif;
            --font-body: "Cairo", sans-serif;
        }
        body { margin: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: var(--font-body); }
        #app { display: flex; height: 100vh; width: 100vw; overflow: hidden; }
        #frame-wrap { flex: 1; position: relative; background: #fff; }
        iframe { width: 100%; height: 100%; border: none; display: block; }
        #sidebar {
            width: 340px; min-width: 340px;
            background: var(--card);
            border-left: 1px solid var(--border);
            backdrop-filter: blur(20px);
            display: flex; flex-direction: column;
            padding: 20px;
            box-shadow: -10px 0 40px rgba(0,0,0,0.6);
            z-index: 9999; direction: rtl;
        }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        h1 {
            font-family: var(--font-title); font-size: 1.6rem; margin: 0;
            background: linear-gradient(90deg, var(--primary-dark), var(--primary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .close-btn {
            background: rgba(255,255,255,0.05); color: #888; border: 1px solid var(--border);
            border-radius: 12px; width: 36px; height: 36px; font-size: 1.5rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.3s; line-height: 0;
        }
        .close-btn:hover { background: rgba(255, 50, 50, 0.2); color: #ff5555; border-color: rgba(255, 50, 50, 0.3); transform: rotate(90deg); }
        .stats { display: flex; justify-content: space-between; font-size: 0.9rem; color: #aaa; margin-bottom: 12px; font-weight: 600; }
        .scroll-area { 
            flex: 1; overflow-y: auto; 
            border: 1px solid var(--border); border-radius: 16px; 
            background: rgba(0,0,0,0.2); margin-bottom: 20px; padding: 5px; 
        }
        .c-item {
            display: flex; align-items: center; padding: 12px; margin-bottom: 6px;
            border: 1px solid rgba(255,255,255,0.02); border-radius: 12px;
            background: rgba(255,255,255,0.03); cursor: pointer; transition: 0.2s;
        }
        .c-item:hover { background: rgba(255,255,255,0.08); transform: translateX(-3px); }
        .c-item input { margin-left: 12px; width: 18px; height: 18px; accent-color: var(--primary); cursor: pointer; }
        .c-item span { font-size: 0.9rem; font-weight: 600; }
        .actions { display: flex; flex-direction: column; gap: 12px; }
        select {
            width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border);
            background: rgba(255,255,255,0.05); color: #fff; outline: none; font-family: var(--font-body); font-weight: 700;
            cursor: pointer; transition: 0.3s;
        }
        select:hover { border-color: var(--primary); }
        #run {
            width: 100%; padding: 15px; border: none; border-radius: 99px;
            background: linear-gradient(90deg, var(--primary-dark), var(--primary));
            color: #fff; font-family: var(--font-title); font-size: 1.1rem; font-weight: 700;
            cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(94, 156, 255, 0.2);
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        #run:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(94, 156, 255, 0.3); }
        #run:disabled { background: #333; color: #777; cursor: not-allowed; transform: none; box-shadow: none; }
        #status { margin-top: 20px; text-align: center; font-size: 0.95rem; font-weight: 600; min-height: 20px; color: var(--text); }
        .footer { margin-top: auto; padding-top: 15px; text-align: center; font-size: 0.8rem; color: #555; font-family: var(--font-title); }
        .footer a { color: var(--primary); text-decoration: none; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }
    `;

    const listItems = courses.map(c => 
        `<label class="c-item"><input type="checkbox" class="chk" value="${c.id}" checked><span>${c.name}</span></label>`
    ).join('');

    d.body.innerHTML = `<style>${css}</style>
    <div id="app">
        <div id="frame-wrap"><iframe id="ifr" src="${loc}"></iframe></div>
        <div id="sidebar">
            <div class="header-row">
                <h1>Ø§Ù„Ù…Ù‚ÙŠÙ… Ø§Ù„Ø¢Ù„ÙŠ</h1>
                <button class="close-btn" onclick="location.reload()" title="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
            </div>
            <div class="stats">
                <label style="cursor:pointer;display:flex;align-items:center"><input type="checkbox" id="all" checked style="margin-left:8px"> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</label>
                <span id="cnt">${courses.length}/${courses.length}</span>
            </div>
            <div class="scroll-area">${listItems}</div>
            <div class="actions">
                <select id="rate">
                    <option value="0">Ù…ÙˆØ§ÙÙ‚ Ø¨Ø´Ø¯Ø©</option>
                    <option value="1" selected>Ù…ÙˆØ§ÙÙ‚</option>
                    <option value="2">Ù…Ø­Ø§ÙŠØ¯</option>
                    <option value="3">ØºÙŠØ± Ù…ÙˆØ§ÙÙ‚</option>
                </select>
                <button id="run">
                    <span>Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</span> <i style="font-style:normal">ğŸš€</i>
                </button>
            </div>
            <div id="status">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡...</div>
            <div class="footer">
                Developed by <a href="https://t.me/MUTLAQ1" target="_blank">MUTLAQ</a>
            </div>
        </div>
    </div>`;

    const iframe = d.getElementById('ifr');
    const runBtn = d.getElementById('run');
    const status = d.getElementById('status');
    const chkAll = d.getElementById('all');
    const countDisplay = d.getElementById('cnt');
    const checks = d.querySelectorAll('.chk');
    const rateSel = d.getElementById('rate');
    
    let queue = [], active = false, retry = 0;

    const refreshCount = () => {
        const n = d.querySelectorAll('.chk:checked').length;
        countDisplay.innerText = `${n}/${courses.length}`;
        runBtn.innerHTML = n > 0 ? `<span>Ø¨Ø¯Ø¡ ØªÙ‚ÙŠÙŠÙ… (${n})</span> ğŸš€` : '<span>Ø§Ø®ØªØ± Ù…ÙˆØ§Ø¯ Ù„Ù„Ø¨Ø¯Ø¡</span>';
        runBtn.disabled = n === 0;
    };

    chkAll.onchange = (e) => {
        checks.forEach(c => c.checked = e.target.checked);
        refreshCount();
    };

    checks.forEach(c => c.onchange = refreshCount);
    refreshCount();

    runBtn.onclick = () => {
        queue = Array.from(d.querySelectorAll('.chk:checked')).map(c => c.value);
        if (!queue.length) return;
        
        active = true;
        runBtn.disabled = true;
        chkAll.disabled = true;
        rateSel.disabled = true;
        checks.forEach(c => c.disabled = true);
        runBtn.innerHTML = '<span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„...</span> â³';
        startLoop();
    };

    const startLoop = () => {
        if (!active) return;
        const loop = setInterval(() => {
            try {
                const doc = iframe.contentDocument;
                if (!doc || doc.readyState !== 'complete') return;

                const msg = doc.getElementById('frm:errorMsg2');
                const backBtn = doc.querySelector('a[id*="back"], a[class*="btn"], input[value*="Ø¹ÙˆØ¯Ø©"]');
                const isBack = backBtn && (backBtn.innerText.includes('Ø±Ø¬ÙˆØ¹') || backBtn.innerText.includes('Back') || backBtn.value?.includes('Ø¹ÙˆØ¯Ø©'));

                if ((msg || doc.body.innerText.includes('ØªÙ… Ø­ÙØ¸')) && isBack) {
                    status.innerText = 'ğŸ”™ ØªÙ… Ø§Ù„Ø­ÙØ¸ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹ÙˆØ¯Ø©...';
                    status.style.color = '#00c853';
                    backBtn.click();
                    clearInterval(loop);
                    setTimeout(startLoop, 800);
                    return;
                }

                if (doc.querySelector('table.rowFlow')) {
                    if (queue.length === 0) {
                        active = false;
                        status.innerText = 'âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!';
                        status.style.color = '#00c853';
                        runBtn.innerHTML = '<span>ØªÙ…Øª Ø§Ù„Ù…Ù‡Ù…Ø©</span> ğŸ‰';
                        runBtn.style.background = 'var(--green)';
                        alert('ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.');
                        clearInterval(loop);
                        return;
                    }

                    const cid = queue[0];
                    const link = doc.querySelector(`a[onmousedown*="setIndex(${cid})"]`);

                    if (link) {
                        status.innerText = `â³ Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ø§Ù„Ù…Ø§Ø¯Ø© ${cid}...`;
                        status.style.color = 'var(--primary)';
                        const evt = d.createEvent('MouseEvents');
                        evt.initEvent('mousedown', true, true);
                        link.dispatchEvent(evt);
                        link.click();
                        queue.shift();
                        retry = 0;
                        clearInterval(loop);
                        setTimeout(startLoop, 1000);
                    } else {
                        retry++;
                        if (retry > 10) { 
                            status.innerText = `âš ï¸ ØªØ®Ø·ÙŠ ${cid} (ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯)`;
                            queue.shift(); 
                            retry = 0; 
                        }
                    }
                    return;
                }

                const radios = doc.querySelectorAll('input[type="radio"]');
                if (radios.length) {
                    status.innerText = 'ğŸ“ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù† ÙˆØ­Ù„ Ø§Ù„ÙØ®Ø§Ø®...';
                    status.style.color = '#ffc400';
                    const rating = parseInt(rateSel.value);
                    let traps = 0;

                    doc.querySelectorAll('table tbody tr').forEach(row => {
                        const rds = row.querySelectorAll('input[type="radio"]');
                        if (rds.length > 2) {
                            const txt = row.innerText;
                            if (/Ø¸Ù„Ù„|ØªØ£ÙƒØ¯|Select|Ø®ÙŠØ§Ø±|Choose|Consistent/.test(txt)) {
                                rds[rds.length - 1].checked = true;
                                traps++;
                            } else if (rds[rating]) {
                                rds[rating].checked = true;
                            }
                        }
                    });

                    doc.querySelectorAll('textarea').forEach(t => t.value = '.');
                    status.innerText = `ğŸ’¾ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ (${traps} ÙØ®)...`;
                    
                    const s = doc.createElement('script');
                    s.textContent = "if(typeof submitForm=='function'){submitForm('/qu')}else{document.forms[0].submit()}";
                    doc.body.appendChild(s);
                    
                    clearInterval(loop);
                    setTimeout(startLoop, 1500);
                }
            } catch (e) {
                console.error(e);
            }
        }, 500);
    };
})();
