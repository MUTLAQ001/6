(function() {
    'use strict';
    const d = document;
    const loc = d.location.href;
    const table = d.querySelector('table.rowFlow');

    if (!table) return alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø© ÙÙŠ ØµÙØ­Ø© "ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ù‚Ø±Ø±Ø§Øª"');

    let courses = [];
    d.querySelectorAll('table.rowFlow tbody tr').forEach(r => {
        const a = r.querySelector('a[onmousedown*="setIndex"]');
        if (a) {
            const m = a.getAttribute('onmousedown').match(/\d+/);
            if (m) courses.push({ id: m[0], name: r.cells[1] ? r.cells[1].innerText : 'M' + m[0] });
        }
    });

    if (!courses.length) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù…ØªØ§Ø­Ø©');

    const css = `
        @import url("https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=IBM+Plex+Sans+Arabic:wght@700&display=swap");
        :root {
            --p: #3b82f6;
            --bg: #0f172a;
            --card: rgba(30, 41, 59, 0.95);
            --txt: #f1f5f9;
            --bd: rgba(255,255,255,0.1);
        }
        body { margin: 0; overflow: hidden; background: var(--bg); color: var(--txt); font-family: "Cairo", sans-serif; }
        #app { display: flex; height: 100vh; width: 100vw; overflow: hidden; }
        
        /* Layout Handling */
        #sidebar {
            width: 350px; flex-shrink: 0;
            background: var(--card);
            border-left: 1px solid var(--bd);
            backdrop-filter: blur(10px);
            display: flex; flex-direction: column;
            padding: 20px; box-sizing: border-box;
            z-index: 9999; direction: rtl;
        }
        #frame-wrap { flex: 1; position: relative; background: #fff; }
        iframe { width: 100%; height: 100%; border: none; }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            #app { flex-direction: column-reverse; }
            #sidebar { 
                width: 100%; height: 55vh; 
                border-left: none; border-top: 1px solid var(--bd);
                border-radius: 20px 20px 0 0;
                box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            }
            #frame-wrap { height: 45vh; }
            h1 { font-size: 1.2rem !important; }
            .c-item { padding: 8px !important; }
        }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        h1 { margin: 0; font-family: "IBM Plex Sans Arabic"; font-size: 1.5rem; background: linear-gradient(90deg, #60a5fa, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .close-btn {
            background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2);
            width: 32px; height: 32px; border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: 0.2s;
        }
        .close-btn:hover { background: #ef4444; color: #fff; }

        /* List & Controls */
        .bar { display: flex; justify-content: space-between; font-size: 0.85rem; color: #94a3b8; margin-bottom: 10px; font-weight: 600; }
        .list { 
            flex: 1; overflow-y: auto; background: rgba(0,0,0,0.2); 
            border: 1px solid var(--bd); border-radius: 12px; padding: 5px; margin-bottom: 15px;
        }
        .c-item {
            display: flex; align-items: center; padding: 10px; margin-bottom: 4px;
            background: rgba(255,255,255,0.03); border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .c-item:hover { background: rgba(255,255,255,0.08); }
        .c-item input { margin-left: 10px; accent-color: var(--p); width: 18px; height: 18px; }
        
        .ctrls { display: flex; flex-direction: column; gap: 10px; }
        select {
            background: rgba(255,255,255,0.05); color: #fff; border: 1px solid var(--bd);
            padding: 12px; border-radius: 10px; outline: none; font-family: inherit; font-weight: 600;
        }
        #run {
            background: linear-gradient(90deg, #2563eb, #3b82f6); color: #fff;
            padding: 14px; border: none; border-radius: 99px; font-weight: 700; font-size: 1rem;
            cursor: pointer; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); transition: 0.3s;
        }
        #run:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4); }
        #run:disabled { background: #334155; color: #94a3b8; transform: none; box-shadow: none; cursor: not-allowed; }

        #st { margin-top: 15px; text-align: center; font-size: 0.9rem; font-weight: 600; color: #fbbf24; min-height: 1.5em; }
        .ft { margin-top: auto; text-align: center; font-size: 0.75rem; color: #475569; padding-top: 10px; }
        .ft a { color: var(--p); text-decoration: none; }
        
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    `;

    const items = courses.map(c => 
        `<label class="c-item"><input type="checkbox" class="chk" value="${c.id}" checked><span>${c.name}</span></label>`
    ).join('');

    d.body.innerHTML = `<style>${css}</style>
    <div id="app">
        <div id="sidebar">
            <div class="header">
                <h1>Ø§Ù„Ù…Ù‚ÙŠÙ… Ø§Ù„Ø¢Ù„ÙŠ</h1>
                <button class="close-btn" onclick="location.reload()">âœ•</button>
            </div>
            <div class="bar">
                <label style="cursor:pointer;display:flex;align-items:center"><input type="checkbox" id="all" checked style="margin-left:8px"> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</label>
                <span id="cnt">${courses.length}/${courses.length}</span>
            </div>
            <div class="list">${items}</div>
            <div class="ctrls">
                <select id="rate">
                    <option value="0">Ù…ÙˆØ§ÙÙ‚ Ø¨Ø´Ø¯Ø©</option>
                    <option value="1" selected>Ù…ÙˆØ§ÙÙ‚</option>
                    <option value="2">Ù…Ø­Ø§ÙŠØ¯</option>
                    <option value="3">ØºÙŠØ± Ù…ÙˆØ§ÙÙ‚</option>
                </select>
                <button id="run">Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ğŸš€</button>
            </div>
            <div id="st">Ø¬Ø§Ù‡Ø²...</div>
            <div class="ft">Developed by <a href="https://t.me/MUTLAQ1" target="_blank">MUTLAQ</a></div>
        </div>
        <div id="frame-wrap"><iframe id="ifr" src="${loc}"></iframe></div>
    </div>`;

    const ifr = d.getElementById('ifr');
    const btn = d.getElementById('run');
    const st = d.getElementById('st');
    const all = d.getElementById('all');
    const cnt = d.getElementById('cnt');
    const chks = d.querySelectorAll('.chk');
    
    let queue = [], act = false, rty = 0;

    const upd = () => {
        const n = d.querySelectorAll('.chk:checked').length;
        cnt.innerText = `${n}/${courses.length}`;
        btn.innerText = n ? `Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (${n}) ğŸš€` : 'Ø§Ø®ØªØ± Ù…ÙˆØ§Ø¯';
        btn.disabled = !n;
    };

    all.onchange = e => { chks.forEach(c => c.checked = e.target.checked); upd(); };
    chks.forEach(c => c.onchange = upd);
    upd();

    btn.onclick = () => {
        queue = Array.from(d.querySelectorAll('.chk:checked')).map(c => c.value);
        if(!queue.length) return;
        act = true;
        [btn, all, d.getElementById('rate'), ...chks].forEach(e => e.disabled = true);
        btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„... â³';
        proc();
    };

    const proc = () => {
        if(!act) return;
        const tm = setInterval(() => {
            try {
                const doc = ifr.contentDocument;
                if(!doc || doc.readyState !== 'complete') return;

                const msg = doc.getElementById('frm:errorMsg2');
                const bBtn = doc.querySelector('a[id*="back"], a[class*="btn"], input[value*="Ø¹ÙˆØ¯Ø©"]');
                const isB = bBtn && /Ø±Ø¬ÙˆØ¹|Back|Ø¹ÙˆØ¯Ø©/.test(bBtn.innerText || bBtn.value);

                if((msg || doc.body.innerText.includes('ØªÙ… Ø­ÙØ¸')) && isB) {
                    st.innerText = 'ğŸ”™ Ø­ÙØ¸ ÙˆØ¹ÙˆØ¯Ø©...';
                    st.style.color = '#4ade80';
                    bBtn.click();
                    clearInterval(tm);
                    setTimeout(proc, 800);
                    return;
                }

                if(doc.querySelector('table.rowFlow')) {
                    if(!queue.length) {
                        act = false;
                        st.innerText = 'âœ… Ø§Ù†ØªÙ‡Ù‰ Ø¨Ù†Ø¬Ø§Ø­!';
                        btn.innerText = 'ØªÙ…Øª Ø§Ù„Ù…Ù‡Ù…Ø© ğŸ‰';
                        btn.style.background = '#059669';
                        alert('ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯.');
                        clearInterval(tm);
                        return;
                    }
                    const id = queue[0];
                    const lk = doc.querySelector(`a[onmousedown*="setIndex(${id})"]`);
                    if(lk) {
                        st.innerText = `â³ ÙØªØ­ ${id}...`;
                        st.style.color = '#60a5fa';
                        const ev = d.createEvent('MouseEvents');
                        ev.initEvent('mousedown', true, true);
                        lk.dispatchEvent(ev);
                        lk.click();
                        queue.shift();
                        rty = 0;
                        clearInterval(tm);
                        setTimeout(proc, 1000);
                    } else {
                        if(++rty > 8) { queue.shift(); rty = 0; }
                    }
                    return;
                }

                const rds = doc.querySelectorAll('input[type="radio"]');
                if(rds.length) {
                    st.innerText = 'âœï¸ Ø­Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...';
                    st.style.color = '#fbbf24';
                    const idx = parseInt(d.getElementById('rate').value);
                    let trps = 0;
                    doc.querySelectorAll('table tbody tr').forEach(r => {
                        const rs = r.querySelectorAll('input[type="radio"]');
                        if(rs.length > 2) {
                            if(/Ø¸Ù„Ù„|ØªØ£ÙƒØ¯|Select|Ø®ÙŠØ§Ø±|Choose/.test(r.innerText)) {
                                rs[rs.length-1].checked = true;
                                trps++;
                            } else if(rs[idx]) rs[idx].checked = true;
                        }
                    });
                    doc.querySelectorAll('textarea').forEach(t => t.value = '.');
                    st.innerText = `ğŸ’¾ Ø­ÙØ¸ (${trps} ÙØ®)...`;
                    const sc = doc.createElement('script');
                    sc.textContent = "typeof submitForm=='function'?submitForm('/qu'):document.forms[0].submit()";
                    doc.body.appendChild(sc);
                    clearInterval(tm);
                    setTimeout(proc, 1500);
                }
            } catch(e) {}
        }, 500);
    };
})();
